<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Airtime - IA Cafe</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="card shadow p-4">
      <h3 class="text-center mb-3">üì± Buy Airtime</h3>

      <!-- Wallet Balance -->
      <div class="alert alert-info text-center">
        Wallet Balance: ‚Ç¶<span id="walletBalance">0.00</span>
      </div>

      <!-- Airtime Form -->
      <form id="airtimeForm">
        <div class="mb-3">
          <label for="serviceID" class="form-label">Network</label>
          <select name="serviceID" id="serviceID" class="form-select" required>
            <option value="">Select Network</option>
            <option value="100">MTN</option>
            <option value="101">AIRTEL</option>
            <option value="102">GLO</option>
            <option value="103">9MOBILE</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="amount" class="form-label">Amount (‚Ç¶)</label>
          <input type="number" name="amount" id="amount" class="form-control" required>
          <small class="text-muted">You'll get 0.5% discount on every purchase</small>
        </div>
        <div class="mb-3">
          <label for="mobileNumber" class="form-label">Phone Number</label>
          <input type="text" name="mobileNumber" id="mobileNumber" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success w-100">Buy Airtime</button>
      </form>

      <div id="airtimeResult" class="mt-3"></div>

      <hr>
      <h5 class="mt-4">üìú Airtime Purchase History</h5>
      <ul id="airtimeHistory" class="list-group"></ul>
    </div>
  </div>

  <script>
  // Fetch User Balance & History
  async function fetchUserData() {
    try {
      const response = await fetch("/api/user");
      const result = await response.json();
      if (result.success) {
        document.getElementById("walletBalance").innerText = Number(result.user.balance).toFixed(2);

        // Filter only airtime transactions
        const airtimeTxns = Object.values(result.transactions || {})
          .filter(txn => txn.type === "airtime");

        const historyList = document.getElementById("airtimeHistory");
        historyList.innerHTML = "";

        if (airtimeTxns.length === 0) {
          historyList.innerHTML = "<li class='list-group-item text-center text-muted'>No airtime purchases yet</li>";
        } else {
          airtimeTxns.reverse().forEach(txn => {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.innerHTML = `
              <strong>${txn.network}</strong> - ‚Ç¶${txn.amount}  
              <br><small>${txn.phone} | ${new Date(txn.date).toLocaleString()} | Ref: ${txn.reference}</small>
              <br>Status: <span class="${txn.status === 'success' ? 'text-success' : 'text-danger'}">${txn.status}</span>
            `;
            historyList.appendChild(li);
          });
        }
      } else {
        document.getElementById("walletBalance").innerText = "0.00";
      }
    } catch (err) {
      console.error("Error fetching user data:", err);
    }
  }

  // Handle Airtime Purchase
  document.getElementById("airtimeForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = {
      serviceID: e.target.serviceID.value,
      amount: e.target.amount.value,
      mobileNumber: e.target.mobileNumber.value
    };

    document.getElementById("airtimeResult").innerHTML = `<div class="alert alert-warning">‚è≥ Processing your request...</div>`;

    try {
      const response = await fetch("/buy-airtime", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
      });
      const result = await response.json();

      if (result.success) {
        document.getElementById("airtimeResult").innerHTML = 
          `<div class="alert alert-success">‚úÖ ${result.message}<br>New Balance: ‚Ç¶${result.balance.toFixed(2)}</div>`;
        fetchUserData();
      } else {
        document.getElementById("airtimeResult").innerHTML = 
          `<div class="alert alert-danger">‚ùå ${result.message}</div>`;
      }
    } catch (error) {
      console.error("Purchase Error:", error);
      document.getElementById("airtimeResult").innerHTML = 
        `<div class="alert alert-danger">‚ùå Something went wrong. Try again later.</div>`;
    }
  });

  // Load Data on Page Load
  fetchUserData();
  </script>
</body>
</html>
